<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Socket.io èŠå¤©æµ‹è¯•</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    .user-select {
      margin-bottom: 20px;
      padding: 15px;
      background: #f0f0f0;
      border-radius: 5px;
    }

    .user-select label {
      margin-right: 10px;
      font-weight: bold;
    }

    .user-select select {
      padding: 5px 10px;
      border-radius: 3px;
      border: 1px solid #ccc;
    }

    .user-select button {
      margin-left: 10px;
      padding: 5px 15px;
      background: #409eff;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .user-select button:hover {
      background: #66b1ff;
    }

    .status {
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }

    .status.connected {
      background: #67c23a;
      color: white;
    }

    .status.disconnected {
      background: #909399;
      color: white;
    }

    .chat-section {
      margin-bottom: 20px;
    }

    .chat-section h3 {
      margin-bottom: 10px;
      color: #555;
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .input-group input,
    .input-group select {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .input-group button {
      padding: 8px 20px;
      background: #409eff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .input-group button:hover {
      background: #66b1ff;
    }

    .messages {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      background: #fafafa;
    }

    .message {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      background: white;
      border-left: 3px solid #409eff;
    }

    .message.sent {
      border-left-color: #67c23a;
      background: #f0f9ff;
    }

    .message.received {
      border-left-color: #e6a23c;
      background: #fdf6ec;
    }

    .message .time {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }

    .log {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }

    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-left: 2px solid #409eff;
      background: white;
    }

    .log-entry.error {
      border-left-color: #f56c6c;
      background: #fef0f0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ Socket.io å•èŠç³»ç»Ÿæµ‹è¯•</h1>

    <div class="user-select">
      <label>é€‰æ‹©ç”¨æˆ·ID:</label>
      <select id="userSelect">
        <option value="1">ç”¨æˆ· 1</option>
        <option value="2">ç”¨æˆ· 2</option>
        <option value="3">ç”¨æˆ· 3</option>
      </select>
      <button onclick="connectSocket()">è¿æ¥</button>
      <button onclick="disconnectSocket()">æ–­å¼€</button>
    </div>

    <div id="status" class="status disconnected">æœªè¿æ¥</div>

    <div class="chat-section">
      <h3>ğŸ“¨ å‘é€æ¶ˆæ¯</h3>
      <div class="input-group">
        <select id="receiverSelect">
          <option value="1">å‘é€ç»™ç”¨æˆ· 1</option>
          <option value="2">å‘é€ç»™ç”¨æˆ· 2</option>
          <option value="3">å‘é€ç»™ç”¨æˆ· 3</option>
        </select>
        <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹...">
        <button onclick="sendMessage()">å‘é€</button>
      </div>
    </div>

    <div class="chat-section">
      <h3>ğŸ’¬ æ¶ˆæ¯åˆ—è¡¨</h3>
      <div id="messages" class="messages">
        <p style="color: #999; text-align: center;">æš‚æ— æ¶ˆæ¯</p>
      </div>
    </div>

    <div class="log">
      <strong>ğŸ“‹ æ—¥å¿—:</strong>
      <div id="log"></div>
    </div>
  </div>

  <script>
    let socket = null;
    let currentUserId = 1;
    const messages = [];

    function log(message, isError = false) {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${isError ? 'error' : ''}`;
      const time = new Date().toLocaleTimeString();
      entry.textContent = `[${time}] ${message}`;
      logDiv.insertBefore(entry, logDiv.firstChild);
    }

    function updateStatus(connected) {
      const statusDiv = document.getElementById('status');
      if (connected) {
        statusDiv.className = 'status connected';
        statusDiv.textContent = `âœ… å·²è¿æ¥ (ç”¨æˆ· ${currentUserId})`;
      } else {
        statusDiv.className = 'status disconnected';
        statusDiv.textContent = 'âŒ æœªè¿æ¥';
      }
    }

    function connectSocket() {
      currentUserId = parseInt(document.getElementById('userSelect').value);
      
      if (socket) {
        socket.disconnect();
      }

      log(`å°è¯•è¿æ¥ Socket.io æœåŠ¡å™¨...`);
      
      socket = io('http://localhost:3000', {
        transports: ['websocket'],
        autoConnect: true,
      });

      socket.on('connect', () => {
        log(`âœ… Socket è¿æ¥æˆåŠŸ, ID: ${socket.id}`);
        updateStatus(true);
        
        // ç”¨æˆ·ä¸Šçº¿
        socket.emit('online', { userId: currentUserId }, (response) => {
          log(`ç”¨æˆ· ${currentUserId} ä¸Šçº¿æˆåŠŸ: ${JSON.stringify(response)}`);
        });
      });

      socket.on('disconnect', () => {
        log(`âŒ Socket æ–­å¼€è¿æ¥`);
        updateStatus(false);
      });

      socket.on('connect_error', (error) => {
        log(`âŒ è¿æ¥é”™è¯¯: ${error.message}`, true);
        updateStatus(false);
      });

      socket.on('receiveMessage', (message) => {
        log(`ğŸ“¨ æ”¶åˆ°æ–°æ¶ˆæ¯: ${JSON.stringify(message)}`);
        addMessage(message, 'received');
      });

      socket.on('error', (error) => {
        log(`âŒ é”™è¯¯: ${error}`, true);
      });
    }

    function disconnectSocket() {
      if (socket) {
        socket.disconnect();
        socket = null;
        log('æ‰‹åŠ¨æ–­å¼€è¿æ¥');
        updateStatus(false);
      }
    }

    function sendMessage() {
      if (!socket || !socket.connected) {
        alert('è¯·å…ˆè¿æ¥ Socket.io');
        return;
      }

      const receiverId = parseInt(document.getElementById('receiverSelect').value);
      const content = document.getElementById('messageInput').value.trim();

      if (!content) {
        alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
        return;
      }

      const message = {
        senderId: currentUserId,
        receiverId: receiverId,
        content: content,
        messageType: 'text',
      };

      log(`ğŸ“¤ å‘é€æ¶ˆæ¯: ${JSON.stringify(message)}`);

      socket.emit('sendMessage', message, (response) => {
        if (response.data.success) {
          log(`âœ… æ¶ˆæ¯å‘é€æˆåŠŸ`);
          addMessage(response.data.messageData, 'sent');
          document.getElementById('messageInput').value = '';
        } else {
          log(`âŒ æ¶ˆæ¯å‘é€å¤±è´¥: ${response.data.message}`, true);
        }
      });
    }

    function addMessage(message, type) {
      messages.push({ ...message, type });
      renderMessages();
    }

    function renderMessages() {
      const messagesDiv = document.getElementById('messages');
      
      if (messages.length === 0) {
        messagesDiv.innerHTML = '<p style="color: #999; text-align: center;">æš‚æ— æ¶ˆæ¯</p>';
        return;
      }

      messagesDiv.innerHTML = messages.map(msg => {
        const time = msg.createdAt ? new Date(msg.createdAt).toLocaleTimeString() : new Date().toLocaleTimeString();
        return `
          <div class="message ${msg.type}">
            <div><strong>${msg.type === 'sent' ? 'æˆ‘' : 'ç”¨æˆ· ' + msg.senderId}</strong> â†’ <strong>ç”¨æˆ· ${msg.receiverId}</strong></div>
            <div>${msg.content}</div>
            <div class="time">${time}</div>
          </div>
        `;
      }).join('');

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // å›è½¦å‘é€
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
    window.addEventListener('load', () => {
      log('ğŸ“ é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·é€‰æ‹©ç”¨æˆ·å¹¶ç‚¹å‡»è¿æ¥æŒ‰é’®');
      log('ğŸ’¡ æç¤ºï¼šå¯ä»¥åœ¨å¤šä¸ªæ ‡ç­¾é¡µä¸­æ‰“å¼€æ­¤é¡µé¢ï¼Œé€‰æ‹©ä¸åŒç”¨æˆ·è¿›è¡Œæµ‹è¯•');
    });
  </script>
</body>
</html>
